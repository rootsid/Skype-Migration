from django.shortcuts import render
from django.http import HttpResponse, HttpResponseRedirect
from django.urls import reverse
from tutorial.auth_helper import get_sign_in_url, get_token_from_code, store_token, store_user, remove_user_and_token, \
    get_token
from tutorial.graph_helper import get_user, get_calendar_events
import dateutil.parser


def initialize_context(request):
    context = {}

    # Check for any errors in the session
    error = request.session.pop('flash_error', None)

    if error != None:
        context['errors'] = []
        context['errors'].append(error)

        # Check for user in the session
    context['user'] = request.session.get('user', {'is_authenticated': False})
    return context


def home(request):
    context = initialize_context(request)
    return render(request, 'tutorial/home.html', context)


def sign_in(request):
    # Get the sign-in URL
    sign_in_url, state = get_sign_in_url()
    # Save the expected state so we can validate in the callback
    request.session['auth_state'] = state
    # Redirect to the Azure sign-in page
    return HttpResponseRedirect(sign_in_url)


# The signin action generates the Azure AD signin URL, saves the state value generated by the OAuth client, then redirects the browser to the Azure AD signin page.

# def callback(request):
#     # Getting the state saved in the session
#     expected_state = request.session.pop("auth.state", '')
#     # This is token request
#     token = get_token_from_code(request.get_full_path(), expected_state)
#     # Temporary save the response in an error so it;s displayed.
#     request.session['flash_error'] = {'message': 'Token retrieved', 'debug': format(token)}
#     return HttpResponseRedirect(reverse('home'))

# The callback action is where Azure redirects after the signin is complete. That action makes sure the state value matches the saved value, then uses the authorization code sent by Azure to request an access token. It then redirects back to the home page with the access token in the temporary error value. You'll use this to verify that our sign-in is working before moving on.

# def callback(request):
#     # Get the state saved in session
#     expected_state = request.session.pop('auth_state', '')
#     # Make the token request
#     token = get_token_from_code(request.get_full_path(), expected_state)
#
#     # Get the user's profile
#     user = get_user(token)
#     # Temporary! Save the response in an error so it's displayed
#     request.session['flash_error'] = {'message': 'Token retrieved',
#                                       'debug': 'User: {0}\nToken: {1}'.format(user, token)}
#     return HttpResponseRedirect(reverse('home'))

def callback(request):
    # Get the state saved in session
    expected_state = request.session.pop('auth_state', '')
    # Make the token request
    token = get_token_from_code(request.get_full_path(), expected_state)

    # Get the user's profile
    user = get_user(token)

    # Save token and user
    store_token(request, token)
    store_user(request, user)

    return HttpResponseRedirect(reverse('home'))


def sign_out(request):
    # Clear out the user and token
    remove_user_and_token(request)

    return HttpResponseRedirect(reverse('home'))


# def calendar(request):
#     context = initialize_context(request)
#
#     token = get_token(request)
#     events = get_calendar_events(token)
#     context['errors'] = [
#         {'message': 'Events', 'debug': format(events)}
#     ]
#     return render(request, 'tutorial/home.html', context)

def calendar(request):
    context = initialize_context(request)
    token = get_token(request)
    events = get_calendar_events(token)

    if events:
        # Convert the ISO 8601 date times to a datetime object
        # This allows the Django template to format the value nicely
        for event in events['value']:
            event['start']['dateTime'] = dateutil.parser.parse(event['start']['dateTime'])
            event['end']['dateTime'] = dateutil.parser.parse(event['end']['dateTime'])

        context['events'] = events['value']

    return render(request, 'tutorial/calendar.html', context)
